#!/bin/bash
# AmneziaVPN service wrapper helper to mitigate DBus issues

# Function to ensure systemd-resolved is in a clean state
reset_systemd_resolved() {
    echo "Resetting systemd-resolved to prevent DBus communication issues..."
    systemctl restart systemd-resolved
    sleep 3
    if ! systemctl is-active --quiet systemd-resolved; then
        echo "Warning: systemd-resolved failed to start, retrying..."
        systemctl restart systemd-resolved
        sleep 3
    fi

    if ! resolvectl status >/dev/null 2>&1; then
        echo "Warning: systemd-resolved DBus interface not responding properly"
        systemctl reload dbus
        sleep 2
        systemctl restart systemd-resolved
        sleep 3
    fi
    echo "systemd-resolved reset completed"
}

# Reset systemd-resolved before starting AmneziaVPN
# This is crucial to prevent the DNS issues seen in subsequent connections
reset_systemd_resolved
export DBUS_SESSION_BUS_ADDRESS=""
export DBUS_SYSTEM_BUS_ADDRESS="unix:path=/var/run/dbus/system_bus_socket"
unset DBUS_SESSION_BUS_ADDRESS

echo "Starting AmneziaVPN service with proper DBus environment..."
exec /home/dennybaa/.nix-profile/bin/AmneziaVPN-service "$@"
